# config/config.example.yaml
# Template for go-mail-webhook-service application configuration.
# Copy this file to config/config.yaml and replace placeholder values with real ones.
#
# Notes:
# - The top-level structure is a single YAML object (one configuration).
# - Supported selector types: "subjectRegex", "bodyRegex", "attachmentNameRegex", "senderRegex"
# - Supported HTTP methods: GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS, TRACE
#
# Placeholders:
# - Use ${SelectorName} in callback values (headers/queryParams/form/body) to reference a selector's extracted value.
# - Selector names must be alphanumeric only (^[0-9A-Za-z]+$).
#
# Callback schema:
# - callback.headers: list of {key, value} where key allows alphanumeric and hyphens
# - callback.queryParams: list of {key, value} where key is alphanumeric only
# - callback.form: list of {key, value} (multipart/form-data) where key is alphanumeric only
# - callback.attachments: configuration for forwarding email attachments (multipart file parts)
# - callback.body: raw string body; you can build JSON or any text yourself and include placeholders

# Comprehensive configuration demonstrating selectors and structured callback sections
mailClientConfig:
  # Gmail address used by the mail client
  mail: "your-account@gmail.com"
  # Path to the directory containing OAuth2 credentials JSON inside the container
  # Mount a Kubernetes Secret at this directory (e.g., /secrets/mail)
  credentialsPath: "/secrets/mail"

mailSelectors:
  # Extract numeric Order ID from the email subject
  - name: "OrderId"
    type: "subjectRegex"
    pattern: "Order ([0-9]+) confirmed"
    captureGroup: 1
    scope: true   # true means this selector must match for the mail to be in scope

  # Extract amount value from the email body
  - name: "Amount"
    type: "bodyRegex"
    pattern: "Total: \\$([0-9]+\\.[0-9]{2})"
    captureGroup: 1
    scope: false

  # Extract sender email address domain (e.g., captures "example.com" from "user@example.com")
  - name: "SenderDomain"
    type: "senderRegex"
    pattern: "@([^@]+)$"
    captureGroup: 1
    scope: false

  # Extract a number from an attachment file name like 'invoice-12345.pdf'
  - name: "FileNum"
    type: "attachmentNameRegex"
    pattern: "invoice-([0-9]+)\\.pdf"
    captureGroup: 1
    scope: false

callback:
  # The webhook endpoint to call with extracted values
  url: "https://example.net/webhook"
  # HTTP method must be one of: GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS, TRACE
  method: "POST"
  # Request timeout (Go duration format). Default is "24s" if omitted.
  timeout: "24s"
  # Number of retry attempts for the callback. Must be >= 0. Default is 0.
  retries: 0

  # Structured sections
  headers:
    # Header example: hyphens allowed in header names
    - key: "X-Order-Id"
      value: "${OrderId}"
    # Often you may need to set a content type when using raw body
    - key: "Content-Type"
      value: "application/json"

  queryParams:
    # Query parameter example (alphanumeric key)
    - key: "fileNum"
      value: "${FileNum}"

  form:
    # Form field example (sent as multipart/form-data)
    - key: "note"
      value: "Processed order ${OrderId}"

  # Forward attachments as multipart/form-data file parts
  # Note: When attachments.enabled is true (or form has fields), the request will be multipart/form-data.
  # If you also need to send a structured payload, include it as form fields.
  attachments:
    enabled: false
    fieldPrefix: "attachment"      # Parts will be named like "attachment_0", "attachment_1", ...
    maxSize: 0                     # 0 or negative means no per-attachment size limit

  # Raw body: build JSON yourself using placeholders if needed
  # Note: Raw body is only used when not sending multipart/form-data (i.e., no form fields and no attachments).
  body: |
    {
      "amount": "${Amount}",
      "senderDomain": "${SenderDomain}"
    }

# Minimal configuration (GET with query param)
# Uncomment below to use a minimal example instead of the comprehensive one
# mailClientConfig:
#   mail: "your-account@gmail.com"
#   credentialsPath: "/secrets/mail"
#
# mailSelectors:
#   # Capture a URL from the email body (full match)
#   - name: "Link"
#     type: "bodyRegex"
#     pattern: "https?://(www\\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}([-a-zA-Z0-9()@:%_+.~#?&/=]*)"
#     captureGroup: 0   # 0 means use the entire match
#     scope: false
#
# callback:
#   url: "https://api.example.com/collect"
#   method: "GET"
#   timeout: "10s"
#   retries: 1
#   queryParams:
#     - key: "url"
#       value: "${Link}"
