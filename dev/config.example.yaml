# config/config.example.yaml
# Template for go-mail-webhook-service application configuration using gohook.Config for callbacks.
# Copy this file to config/config.yaml and replace placeholder values with real ones.
#
# Notes:
# - The top-level structure is a single YAML object (one configuration).
# - Supported selector types: "subjectRegex", "bodyRegex", "attachmentNameRegex", "senderRegex", "recipientRegex"
# - Supported HTTP methods: GET, HEAD, POST, PUT, PATCH, DELETE, OPTIONS, TRACE (gohook leaves method free-form; choose appropriately)
#
# Placeholders (gohook templates):
# - Use {{ .SelectorName }} in callback values (URL/headers/query/body) to reference a selector's extracted value.
# - Selector names must be alphanumeric only (^[0-9A-Za-z]+$).
#
# Callback schema (delegated to gohook.Config):
# - callback.url: string (may contain templates)
# - callback.method: string (if empty, defaults to POST when body is non-empty else GET)
# - callback.headers: map[string]string (keys and values may contain templates)
# - callback.query: map[string]string (keys and values may contain templates)
# - callback.contentType: string (applied if set and not already set via headers)
# - callback.body: string (raw request body; may contain templates)
# - callback.timeout: string (Kubernetes-style duration, e.g., "10s", "3m", "1h30m", "4d")
# - callback.insecureSkipVerify: bool (disable TLS verification for the default client; use only for testing)
# - callback.strictTemplates: bool (true → error on missing keys; false → render as <no value>)
# - callback.expectedStatus: list of acceptable HTTP status codes; when set, unexpected codes cause retries
# - callback.maxRetries: int (number of retry attempts on transport errors/unexpected status)
# - callback.backoff: string (delay between retries; Kubernetes-style duration)
#
# Processing behavior:
# - processing.processedAction controls how an email is marked as processed after a successful webhook call.
#   Supported values:
#     - "markRead" (default): mark the email as read
#     - "delete": delete the email after successful processing (irreversible in Gmail)
#
# Selector behavior:
# - All selectors provided must match for an email to be processed. If any selector fails to match, the email is skipped.

# Logging level: "debug" | "info" | "warn" | "error"
logLevel: "info"

mailSelectors:
  # Extract numeric Order ID from the email subject
  - name: "OrderId"
    type: "subjectRegex"
    pattern: "Order ([0-9]+) confirmed"
    captureGroup: 1

  # Extract amount value from the email body
  - name: "Amount"
    type: "bodyRegex"
    pattern: "Total: \\$([0-9]+\\.[0-9]{2})"
    captureGroup: 1

  # Extract sender email address domain (e.g., captures "example.com" from "user@example.com")
  - name: "SenderDomain"
    type: "senderRegex"
    pattern: "@([^@]+)$"
    captureGroup: 1

  # Extract a number from an attachment file name like 'invoice-12345.pdf'
  - name: "FileNum"
    type: "attachmentNameRegex"
    pattern: "invoice-([0-9]+)\\.pdf"
    captureGroup: 1

callback:
  # The webhook endpoint to call with extracted values
  # here we use host.docker.internal to access a service running on the host machine from inside the Docker container; adjust as needed for your environment
  url: "http://host.docker.internal:8080/api?fileNum={{ .FileNum }}"
  # HTTP method
  method: "POST"

  # Request timeout (Kubernetes-style duration). Default is "24s" if omitted.
  timeout: "24s"

  # Retry configuration
  maxRetries: 0
  backoff: "0s"
  expectedStatus: [200, 201]

  # Strict template handling and optional TLS settings
  strictTemplates: true
  insecureSkipVerify: false

  # Headers as a map (keys and values can use templates)
  headers:
    X-Order-Id: "{{ .OrderId }}"
    Content-Type: "application/json"

  # Additional query parameters as a map (merged with URL's query)
  query:
    senderDomain: "{{ .SenderDomain }}"

  # Optional explicit content type (used when not set via headers)
  # contentType: "application/json"

  # Raw body: build JSON yourself using gohook templates
  body: |
    {
      "amount": "{{ .Amount }}",
      "source": "go-mail-webhook-service"
    }

# Processing behavior: choose how to mark mails after successful processing
processing:
  # Supported values: "markRead" (default) or "delete"
  processedAction: "markRead"

# Minimal configuration example (GET with query param)
# Uncomment below to use a minimal example instead of the comprehensive one
#
# mailSelectors:
#   - name: "Link"
#     type: "bodyRegex"
#     pattern: "https?://(www\\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}([-a-zA-Z0-9()@:%_+.~#?&/=]*)"
#     captureGroup: 0
#
# callback:
#   url: "https://api.example.com/collect?url={{ .Link }}"
#   method: "GET"
#   timeout: "10s"
#   expectedStatus: [200]